name: CI/CD Pipeline

on:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
    - name: Set up Docker
      uses: actions/setup-docker@v2
    - name: Build Docker Image
      run: docker build -t nginx.
    - name: Log in to Docker Hub (or your container registry)
      run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
    - name: Push Docker Image
      run: docker push nginx
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Install kubectl
      uses: setup-kubectl@v1
      with:
        version: 'latest'
    - name: Deploy to Kubernetes
      run: kubectl apply -f /home/ubuntu/myrepository/
  deploy-to-ec2:
     runs-on: ubuntu-latest
     steps:
     - name: Copy Kubernetes Manifests to EC2
       uses: appleboy/scp-action@master
       with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: 'https://github.com/elumalai-n/myrepository/deployment.yaml'
        target: '/home/ubuntu/myrespository/'

     - name: SSH into EC2 and Apply Kubernetes Manifests
       uses: appleboy/ssh-action@master
       with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /home/ubuntu/myrepository/
          kubectl apply -f deployment.yaml

